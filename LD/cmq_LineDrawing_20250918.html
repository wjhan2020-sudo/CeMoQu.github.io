<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ataxia Diagnostic Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #f4f4f4;
            --text: #222;
            --accent: #1976d2;
        }

        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            padding: 10px 20px;
            background-color: var(--accent);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
        }

        #main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        #canvas-container {
            flex: 2;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            border-right: 1px solid #ccc;
            position: relative;
        }

        canvas {
            border: 1px solid #ccc;
            background: #fff;
            touch-action: none;
        }

        #stats-panel {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: var(--bg);
        }

        #sidebar {
            width: 250px;
            background-color: #eee;
            border-left: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }

        label,
        select,
        button,
        input {
            display: block;
            width: 100%;
            margin: 10px 0;
            font-family: 'Roboto', sans-serif;
        }

        .patient-info {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        #timer-label {
            font-weight: 400;
            margin-bottom: 15px;
            font-size: 1em;
        }

        /* Collapsible clinical score box */
        details {
            margin-top: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: white;
            padding: 8px;
        }

        details summary {
            font-weight: bold;
            cursor: pointer;
            color: var(--accent);
            outline: none;
        }

        details[open] summary {
            border-bottom: 1px solid #ccc;
            margin-bottom: 6px;
        }

        .chart-container {
            width: 100%;
            height: 200px;
            margin-top: 20px;
        }

        .invert-colors {
            filter: invert(1) hue-rotate(180deg);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #999;
            padding: 5px;
            text-align: center;
        }

        th {
            background: #ddd;
        }
    </style>
</head>

<body>
    <header>
        <div><strong>Line Drawing Test - CeMoQu</strong></div>
        <div>
            <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
        </div>
    </header>

    <div id="main">
        <div id="canvas-container">
            <canvas id="testCanvas"></canvas>
        </div>

        <div id="stats-panel">
            <div class="patient-info" id="patientInfo">No patient selected</div>
            <div id="timer-label">Time: <span id="timer">0.00</span> s</div>

            <!-- Collapsible Clinical Score -->
            <details id="clinical-score-box">
                <summary>Clinical Score Mapping</summary>
                <div id="clinical-score-content">
                    <p><em>No data yet. Run a test to compute scores.</em></p>
                </div>
            </details>

            <!-- Stats Table -->
            <table id="statsTable">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Value</th>
                        <th>Mode</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Discontinuities</td><td id="discontValue">0</td><td>—</td></tr>
                    <tr><td>Turns (Vertical)</td><td id="verticalTurnValue">0</td><td>—</td></tr>
                    <tr><td>Reverses (Horizontal)</td><td id="horizontalTurnValue">0</td><td>—</td></tr>
                    <tr><td>Off-by</td><td id="offByValue">0</td><td><input type="number" id="offByThreshold" value="10" style="width:60px" /></td></tr>
                    <tr><td>Deviation Area</td><td id="deviationValue">0</td><td><button id="deviationModeBtn" onclick="toggleDeviationMode()">Total</button></td></tr>
                    <tr><td>Turn Avg</td><td id="turnValue">0</td><td><button id="turnModeBtn" onclick="toggleTurnMode()">Avg Vertical</button></td></tr>
                    <tr><td>Out-of-Bounds</td><td id="outOfBoundsValue">0</td><td>—</td></tr>
                    <tr><td>Start Fails</td><td id="startFailsValue">0</td><td>—</td></tr>
                </tbody>
            </table>
        </div>

        <div id="sidebar">
            <button onclick="openPatientDialog()">New Patient</button>
            <select id="previousPatients" onchange="loadPreviousPatient(this.value)">
                <option value="">Select Previous Patient</option>
            </select>
            <button onclick="clearAllPatients()">Clear All Patients</button>

            <hr>

            <select id="testSelector" onchange="changeTest()">
                <option value="vertical">Vertical Test</option>
                <option value="horizontal">Horizontal Test</option>
                <option value="diagonal1">Diagonal Test 1</option>
                <option value="diagonal2">Diagonal Test 2</option>
            </select>

            <button onclick="stopTest()">Stop Test</button>
            <button onclick="resetTest()">Reset Test</button>
            <button onclick="exportData()">Export Data</button>
        </div>
    </div>

    <!-- Modal for Patient Info -->
    <dialog id="patientDialog">
        <form method="dialog">
            <label>Name: <input type="text" id="patientName" required /></label>
            <label>ID: <input type="text" id="patientID" required /></label>
            <menu>
                <button type="submit" onclick="setPatientInfo()">Confirm</button>
                <button onclick="patientDialog.close()">Cancel</button>
            </menu>
        </form>
    </dialog>

    <script>
        let currentPatient = null;
        let currentTest = null;
        let testActive = false;
        const canvas = document.getElementById("testCanvas");
        const ctx = canvas.getContext("2d");
        const WIDTH = 900, HEIGHT = 600, BOX_SIZE = 50;
        canvas.width = WIDTH; canvas.height = HEIGHT;

        let touches = [], turns = [], pointerdown = false, canDraw = false;
        let startBox, finishBox, startHit = false, finishHit = false, success = false;
        let dx = 0, dy = 0;
        let statistics = { discontinuities: 0, verticalTurns: 0, deviationArea: 0, horizontalTurns: 0, outOfBounds: 0, startFails: 0 };

        let deviationMode = "total";
        let turnMode = "avgVertical";

        function toggleDarkMode() { document.body.classList.toggle("invert-colors"); }

        // === Utility Functions ===
        function getCoordinatesFromEvent(e) { const r = canvas.getBoundingClientRect(); return [e.clientX - r.left, e.clientY - r.top]; }
        function getCurrentTouch() { return touches[touches.length - 1]; }
        function isInsideBox(x, y, b) { return x >= b[0] && x <= b[0]+BOX_SIZE && y >= b[1] && y <= b[1]+BOX_SIZE; }

        function calcDeviation(coords) {
            const [x, y] = coords;
            const sx = startBox[0] + BOX_SIZE/2, sy = startBox[1] + BOX_SIZE/2;
            const ex = finishBox[0] + BOX_SIZE/2, ey = finishBox[1] + BOX_SIZE/2;
            if (sx !== ex) {
                const m = (ey - sy) / (ex - sx);
                const a = -m, b = 1, c = -sy + m*sx;
                return Math.abs(a*x + b*y + c) / Math.sqrt(a*a + b*b);
            } else return Math.abs(x - sx);
        }

        // === Stats + Score ===
        function computeClinicalScore() {
            const deviation_area = statistics.deviationArea;
            const turn_height = (turnMode === "avgVertical") ? statistics.verticalTurns : statistics.horizontalTurns;
            const discontinuities = statistics.discontinuities;
            const reverses = statistics.horizontalTurns;
            const out_of_bounds = statistics.outOfBounds;
            const start_fails = statistics.startFails;

            const score_dev = Math.min(4, deviation_area / 500);
            const score_turn = Math.min(4, turn_height / 150);
            const score_dis = Math.min(4, (discontinuities + reverses) / 5);
            const score_bounds = Math.min(4, (out_of_bounds + start_fails) / 3);
            const sara_score = (score_dev + score_turn + score_dis + score_bounds) / 4;

            let desc = "";
            if (sara_score < 0.5) desc = "Normal, smooth, accurate movement";
            else if (sara_score < 1.5) desc = "Slight tremor or inaccuracy, but target achieved";
            else if (sara_score < 2.5) desc = "Moderate tremor; instability present but functional";
            else if (sara_score < 3.5) desc = "Severe tremor; frequent overshoot or instability";
            else desc = "Inability to reach target or complete task";

            document.getElementById("clinical-score-content").innerHTML = `
                <p><strong>SARA Subscore:</strong> ${sara_score.toFixed(2)} / 4</p>
                <ul>
                    <li><b>Deviation:</b> ${score_dev.toFixed(2)}</li>
                    <li><b>Turns:</b> ${score_turn.toFixed(2)}</li>
                    <li><b>Discontinuities:</b> ${score_dis.toFixed(2)}</li>
                    <li><b>Bounds/Start Fails:</b> ${score_bounds.toFixed(2)}</li>
                </ul>
                <p><em>${desc}</em></p>
            `;

            return {
                score_dev: +score_dev.toFixed(2),
                score_turn: +score_turn.toFixed(2),
                score_dis: +score_dis.toFixed(2),
                score_bounds: +score_bounds.toFixed(2),
                sara_score: +sara_score.toFixed(2),
                description: desc,
                completed_at: new Date().toISOString()
            };
        }

        function updateStats() {
            const th = parseFloat(document.getElementById("offByThreshold").value) || 10;
            document.getElementById("offByValue").innerText = updateOffBy(th);
            let dev = statistics.deviationArea;
            if (deviationMode === "average") dev = totalPointCount() > 0 ? dev / totalPointCount() : 0;
            document.getElementById("deviationValue").innerText = dev.toFixed(2);
            document.getElementById("outOfBoundsValue").innerText = statistics.outOfBounds;
            document.getElementById("startFailsValue").innerText = statistics.startFails;
            document.getElementById("discontValue").innerText = statistics.discontinuities;
            document.getElementById("verticalTurnValue").innerText = statistics.verticalTurns;
            document.getElementById("horizontalTurnValue").innerText = statistics.horizontalTurns;
        }

        function totalPointCount(){return touches.reduce((a,t)=>a+t.points.length,0);}
        function updateOffBy(th){let c=0;for(const t of touches){let last=0;for(const p of t.points){const d=calcDeviation(p);if(d>th&&last<=th)c++;last=d;}}return c;}
        document.getElementById("offByThreshold").addEventListener("input",updateStats);

        // === Drawing & Test Management ===
        const tests = {
            horizontal:{name:"Horizontal Test",position:()=>[[10,HEIGHT/2-BOX_SIZE/2],[WIDTH-10-BOX_SIZE,HEIGHT/2-BOX_SIZE/2]]},
            vertical:{name:"Vertical Test",position:()=>[[WIDTH/2-BOX_SIZE/2,10],[WIDTH/2-BOX_SIZE/2,HEIGHT-10-BOX_SIZE]]},
            diagonal1:{name:"Diagonal Test 1",position:()=>[[10,10],[WIDTH-10-BOX_SIZE,HEIGHT-10-BOX_SIZE]]},
            diagonal2:{name:"Diagonal Test 2",position:()=>[[10,HEIGHT-10-BOX_SIZE],[WIDTH-10-BOX_SIZE,10]]}
        };

        function drawBox(x,y,w,h,c="red",t=""){ctx.fillStyle=c;ctx.fillRect(x,y,w,h);if(t){ctx.fillStyle="white";ctx.font="30px Roboto";const m=ctx.measureText(t);ctx.fillText(t,x+w/2-m.width/2,y+h-15);}}
        function drawLine(sx,sy,ex,ey,w=1){ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(ex,ey);ctx.lineWidth=w;ctx.stroke();ctx.closePath();}
        function drawSuccessText(){ctx.fillStyle="green";ctx.font="bold 60px Roboto";ctx.textAlign="center";ctx.fillText("Success!",WIDTH/2,HEIGHT/2);ctx.textAlign="start";}
        function redrawTest(c=true){if(c)ctx.clearRect(0,0,canvas.width,canvas.height);drawLine(startBox[0]+BOX_SIZE/2,startBox[1]+BOX_SIZE/2,finishBox[0]+BOX_SIZE/2,finishBox[1]+BOX_SIZE/2,0.5);drawBox(startBox[0],startBox[1],BOX_SIZE,BOX_SIZE,startHit?"green":"red","S");drawBox(finishBox[0],finishBox[1],BOX_SIZE,BOX_SIZE,finishHit?"green":"red","F");if(success)drawSuccessText();}
        function resetStats(){statistics={discontinuities:0,verticalTurns:0,deviationArea:0,horizontalTurns:0,outOfBounds:0,startFails:0};dx=0;dy=0;}
        function resetTest(){if(!currentTest)return;ctx.clearRect(0,0,canvas.width,canvas.height);[startBox,finishBox]=currentTest.position();touches=[];canDraw=false;startHit=finishHit=success=false;resetStats();redrawTest();updateStats();}

        let timerId=0;function startTimer(){const t=document.getElementById("timer");const now=Date.now();clearInterval(timerId);timerId=setInterval(()=>{t.innerText=((Date.now()-now)/1000).toFixed(2);},10);}function stopTimer(){clearInterval(timerId);}

        canvas.addEventListener("pointerdown",e=>{pointerdown=true;const c=getCoordinatesFromEvent(e);if(testActive&&!success){const d=calcDeviation(c);if(isInsideBox(c[0],c[1],startBox)){if(startHit){statistics.discontinuities++;}else{startTimer();canDraw=true;startHit=true;redrawTest();}touches.push({points:[[c[0],c[1],Date.now()]]});}else{if(!startHit){statistics.startFails++;}else{statistics.discontinuities++;touches.push({points:[[c[0],c[1],Date.now()]]});statistics.deviationArea+=d;}}updateStats();}});
        canvas.addEventListener("pointerleave",()=>{if(pointerdown&&canDraw&&!success){statistics.outOfBounds++;updateStats();pointerdown=false;}});
        canvas.addEventListener("pointermove",e=>{if(pointerdown&&canDraw&&!success){const c=getCoordinatesFromEvent(e);const lp=getCurrentTouch().points.at(-1);ctx.beginPath();ctx.moveTo(lp[0],lp[1]);ctx.lineTo(c[0],c[1]);ctx.stroke();ctx.closePath();const d=calcDeviation(c);statistics.deviationArea+=d;function norm(a){return a>0?1:a<0?-1:0;}const dxNow=norm(c[0]-lp[0]),dyNow=norm(c[1]-lp[1]);if(dx!==dxNow){statistics.horizontalTurns++;turns.push({horizontal:true,distance:d});}if(dy!==dyNow){statistics.verticalTurns++;turns.push({horizontal:false,distance:d});}dx=dxNow;dy=dyNow;getCurrentTouch().points.push([c[0],c[1],Date.now()]);if(isInsideBox(c[0],c[1],finishBox)){stopTimer();canDraw=false;pointerdown=false;finishHit=true;success=true;redrawTest(false);drawSuccessText();computeClinicalScore();}updateStats();}});
        canvas.addEventListener("pointerup",()=>{pointerdown=false;});
        function changeTest(){const v=document.getElementById("testSelector").value;currentTest=tests[v];testActive=true;resetTest();}
        function stopTest(){testActive=false;stopTimer();pointerdown=false;canDraw=false;computeClinicalScore();}
        function toggleDeviationMode(){deviationMode=deviationMode==="total"?"average":"total";document.getElementById("deviationModeBtn").innerText=deviationMode.charAt(0).toUpperCase()+deviationMode.slice(1);updateStats();}
        function toggleTurnMode(){turnMode=turnMode==="avgVertical"?"avgHorizontal":"avgVertical";document.getElementById("turnModeBtn").innerText=turnMode.charAt(3).toUpperCase()+turnMode.slice(4);updateStats();}

        // === Patient Management ===
        const patientDialog=document.getElementById("patientDialog");
        function openPatientDialog(){patientDialog.showModal();}
        function setPatientInfo(){const n=document.getElementById("patientName").value;const id=document.getElementById("patientID").value;if(!n||!id)return;currentPatient={name:n,id:id};document.getElementById("patientInfo").innerText=`${n} (ID: ${id})`;savePatientList();patientDialog.close();}
        function savePatientList(){let list=JSON.parse(localStorage.getItem("patients")||"[]");if(!list.some(p=>p.id===currentPatient.id))list.push(currentPatient);localStorage.setItem("patients",JSON.stringify(list));updatePatientDropdown();}
        function updatePatientDropdown(){const sel=document.getElementById("previousPatients");sel.innerHTML='<option value="">Select Previous Patient</option>';const list=JSON.parse(localStorage.getItem("patients")||"[]");list.forEach(p=>{const o=document.createElement("option");o.value=p.id;o.textContent=`${p.name} (ID: ${p.id})`;sel.appendChild(o);});}
        function loadPreviousPatient(id){if(!id)return;const list=JSON.parse(localStorage.getItem("patients")||"[]");const p=list.find(p=>p.id===id);if(p){currentPatient=p;document.getElementById("patientInfo").innerText=`${p.name} (ID: ${p.id})`;}}
        function clearAllPatients(){localStorage.removeItem("patients");updatePatientDropdown();document.getElementById("patientInfo").innerText="No patient selected";}
        updatePatientDropdown();

        // === Data Export ===
        function exportData() {
            if (!currentPatient || !currentTest) { alert("Please select patient and test first."); return; }

            const clinical = computeClinicalScore();

            const exportObj = {
                patient: currentPatient,
                test: currentTest.name,
                timestamp: new Date().toISOString(),
                stats: {
                    ...statistics,
                    offByThreshold: parseFloat(document.getElementById("offByThreshold").value) || 10,
                    offByCount: parseFloat(document.getElementById("offByValue").innerText) || 0,
                    deviationMode,
                    deviationShown: parseFloat(document.getElementById("deviationValue").innerText) || 0,
                    turnMode,
                    turnShown: parseFloat(document.getElementById("turnValue").innerText) || 0,
                    clinical
                }
            };

            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `ataxia_data_${currentPatient.id}_${Date.now()}.json`;
            a.click();
        }
    </script>
</body>
</html>
